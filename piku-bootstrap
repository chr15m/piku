#!/bin/sh

# Usage:
# To bootstrap your machine called mybox.com with piku
# 
# ./piku-bootstrap mybox.com

PBD=${PIKU_BOOTSTRAP_DIR:-~/.piku-bootstrap}
VENV="${PBD}/virtualenv"
VIRTUALENV_VERSION="16.0.0"

main() {
  # print a message if this is a first time run
  if [ ! -d "${PBD}" ]; then
    echo "piku-bootstrap - welcome!"
    echo "Looks like this is your first time running this."
    echo "This script will self-install dependencies into ${PBD} now."
    echo
  fi

  # ensure we have a dir
  mkdir -p "${PBD}"

  if [ ! -d "$VENV" ]; then
    echo "Virtualenv setup not found. Installing it into ${PBD}."
    ensure_virtualenv
  fi

  # get into virtualenv
  . "$VENV/bin/activate"

  # ensure ansible
  if [ "`command -v ansible-playbook`" = "" ]
  then
    echo "ansible-playbook binary not found. Installing it into ${PBD}."
    pip install -q "ansible==2.7.10"
  fi

  if [ "$1" = "" ]
  then
    echo "`basename $0` HOSTNAME"
    echo "This will create a user 'piku' on the machine HOSTNAME"
    echo "setup git, and install the piku script there."
    echo "Requires root on HOSTNAME."
  else
    echo "Bootstrapping piku onto $1"
    # TODO: use pyenv + virtualenv on remote instead and install exact versions
    ansible-playbook -i "$1", /dev/stdin << EOF
---
- hosts: all
  user: root
  gather_facts: no
  pre_tasks:
    - name: 'Install python2 required by Ansible'
      raw: apt-get update && apt-get -y install python python-pip python-setuptools

- hosts: all
  user: root
  tasks:
    - name: Add piku user
      user:
        name: piku
        password: !
        comment: PaaS access
        group: www-data

    - name: Install Debian Packages
      apt:
        pkg: ['bc', 'git', 'build-essential', 'libpcre3-dev', 'zlib1g-dev', 'python', 'python3', 'python3-pip', 'python3-dev', 'python3-setuptools', 'nginx', 'incron']
        #, 'python-dev', 'python3', 'python3-virtualenv', 'python3-pip']
        update_cache: true
        state: present

    - name: Install Python packages
      pip:
        executable: pip3
        name: ['setuptools', 'click==7.0', 'virtualenv==15.1.0', 'uwsgi==2.0.15']
      register: packages_installed

    - shell: which uwsgi
      register: uwsgi_location
      when: packages_installed is changed

    - name: Create uwsi symlink
      file:
        src: "{{uwsgi_location.stdout}}"
        dest: /usr/local/bin/uwsgi-piku
        owner: root
        group: root
        state: link
      when: packages_installed is changed

    - name: Install uwsgi dist script
      get_url:
        url: https://raw.githubusercontent.com/rcarmo/piku/master/uwsgi-piku.dist
        dest: /etc/init.d/uwsgi-piku
        mode: 0700
      when: packages_installed is changed

    - name: Setup uwsgi dist script
      shell: update-rc.d uwsgi-piku defaults
      args:
        creates: /etc/rc2.d/S01uwsgi-piku
      when: packages_installed is changed

    - name: Install uwsgi systemd script
      get_url:
        url: https://raw.githubusercontent.com/rcarmo/piku/master/uwsgi-piku.service
        dest: /etc/systemd/system/uwsgi-piku.service
        mode: 0600
      when: packages_installed is changed

    - name: Start uwsgi service
      service:
        name: uwsgi-piku
        state: started
      when: packages_installed is changed

    - name: Create piku ansible tmp dir
      file:
        path: ~piku/.ansible/tmp
        mode: 0700
        owner: piku
        group: www-data
        state: directory

- hosts: all
  user: root
  become: yes
  become_user: piku
  tasks:
    ### TODO: use pyenv like this instead

    #- name: Download pyenv installer
    #  get_url:
    #    url: https://pyenv.run
    #    dest: ~/pyenv-installer
    #    mode: 0755

    #- name: Run pyenv installer
    #  shell:
    #    argv: ~/pyenv-installer
    #    creates: ~/.pyenv

    #- name: Install python3
    #  shell: ~/.pyenv/bin/pyenv install 3.6.8

    #- name: Use python3
    #  shell: ~/.pyenv/bin/pyenv local 3.6.8

    - name: Fetch piku.py script
      get_url:
        url: https://raw.githubusercontent.com/rcarmo/piku/master/piku.py
        dest: ~/piku.py
        mode: 0700

    - name: Run piku setup
      shell: python3 ~/piku.py setup
      args:
        creates: ~/.piku

    - name: Copy up my SSH key for piku
      copy: src=~/.ssh/id_rsa.pub dest=/tmp/id_rsa.pub

    - name: Ask piku to use SSH key
      shell: python3 ~/piku.py setup:ssh /tmp/id_rsa.pub
      args:
        creates: ~/.ssh/authorized_keys

EOF
  fi
}

bail_install() {
    error "Self-installation failed."
    exit 1;
}

ensure_virtualenv() {
  # TODO: use local virtualenv instead if `command -v virtualenv` succeeds
  [ -d "${PBD}/virtualenv" ] || (\
      [ -f "./.virtualenv-source/virtualenv.py" ] || install_virtualenv;
      echo "Setting up the virtual environment." && \
      ./.virtualenv-source/virtualenv.py -p `which python` "${PBD}/virtualenv" || exit 1)
      rm -rf ./.virtualenv-source
}

install_virtualenv() {
  VIRTUALENV_URL="https://pypi.io/packages/source/v/virtualenv/virtualenv-${VIRTUALENV_VERSION}.tar.gz"
  echo "Downloading & installing Virtualenv."
  rm -rf "./.virtualenv-source"
  mkdir -p "./.virtualenv-source"
  [ -f "./virtualenv.tar.gz" ] || curl -f -L -o "./virtualenv.tar.gz" "${VIRTUALENV_URL}" || bail_install
  tar -zxf "./virtualenv.tar.gz" -C "./.virtualenv-source/" --strip-components=1 && \
  [ -d "./.virtualenv-source" ] && (\
          cd "./.virtualenv-source" && \
          /usr/bin/env python setup.py build ) \
          || bail_install;
}

main "$1"
